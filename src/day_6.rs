#[derive (Clone)]
struct Position {
    x: usize,
    y: usize,
}

#[derive (PartialEq, Clone)]
enum Direction {
    Up,
    Down,
    Left,
    Right,
    Unknown,
}

#[derive (Clone)]
struct Guard {
    pos: Position,
    dir: Direction,
}

fn calculate_moves(map_src: &Vec<Vec<char>>, guard_initial: &Guard)->usize {
    let mut map = map_src.clone();
    let mut guard = guard_initial.clone();
    
    let mut before_hit: Vec<Vec<Direction>> = vec![vec![Direction::Unknown; map_src[0].len()]; map_src.len()];
    let mut after_hit: Vec<Vec<Direction>> = vec![vec![Direction::Unknown; map_src[0].len()]; map_src.len()];

    loop {
        map[guard.pos.y][guard.pos.x]='X';
        if before_hit[guard.pos.y][guard.pos.x]==Direction::Unknown {
            before_hit[guard.pos.y][guard.pos.x]=guard.dir.clone();
        } 

        if (guard.dir == Direction::Up && guard.pos.y==0) ||
            (guard.dir == Direction::Down && guard.pos.y==map.len()-1) ||
            (guard.dir == Direction::Right && guard.pos.x==map[guard.pos.y].len()-1) ||
            (guard.dir == Direction::Left && guard.pos.x==0)
        {
                //have exit map
                return map.iter()
                    .map(|line| 
                            line.iter()
                            .filter(|&c| c==&'X')
                            .count()
                        ).collect::<Vec<usize>>().iter().sum();
                
        }
        
        if guard.dir == Direction::Up && guard.pos.y > 0 {
            if map[guard.pos.y-1][guard.pos.x]=='#' {
                guard.dir = Direction::Right;
                if after_hit[guard.pos.y][guard.pos.x]==Direction::Unknown {
                   after_hit[guard.pos.y][guard.pos.x]=guard.dir.clone(); 
                } else if before_hit[guard.pos.y][guard.pos.x]==Direction::Up &&
                            after_hit[guard.pos.y][guard.pos.x]==guard.dir {
                    return 0;
                }
            } else {
                guard.pos.y-=1;
            }
        } else if guard.dir == Direction::Down && guard.pos.y < map.len()-1 {
            if map[guard.pos.y+1][guard.pos.x]=='#' {
                guard.dir = Direction::Left;
                if after_hit[guard.pos.y][guard.pos.x]==Direction::Unknown {
                   after_hit[guard.pos.y][guard.pos.x]=guard.dir.clone(); 
                } else if before_hit[guard.pos.y][guard.pos.x]==Direction::Down &&
                            after_hit[guard.pos.y][guard.pos.x]==guard.dir {
                    return 0;
                }
            } else {
                guard.pos.y+=1;
            }
        } else if guard.dir == Direction::Right && guard.pos.x < map[guard.pos.y].len()-1 {
            if map[guard.pos.y][guard.pos.x+1]=='#' {
                guard.dir = Direction::Down;
                if after_hit[guard.pos.y][guard.pos.x]==Direction::Unknown {
                   after_hit[guard.pos.y][guard.pos.x]=guard.dir.clone(); 
                } else if before_hit[guard.pos.y][guard.pos.x]==Direction::Right &&
                            after_hit[guard.pos.y][guard.pos.x]==guard.dir {
                    return 0;
                }
            } else {
                guard.pos.x+=1;
            }
        } else if guard.dir == Direction::Left && guard.pos.x > 0 {
            if map[guard.pos.y][guard.pos.x-1]=='#' {
                guard.dir = Direction::Up;
                if after_hit[guard.pos.y][guard.pos.x]==Direction::Unknown {
                   after_hit[guard.pos.y][guard.pos.x]=guard.dir.clone(); 
                } else if before_hit[guard.pos.y][guard.pos.x]==Direction::Left &&
                            after_hit[guard.pos.y][guard.pos.x]==guard.dir {
                    return 0;
                }
            } else {
                guard.pos.x-=1;
            }
        }
    }
}

fn count_loops(map_src: &Vec<Vec<char>>, guard_initial: &Guard)->usize {
    let mut loops = 0;
    for j in 0..map_src.len() {
        for i in 0..map_src[j].len() {
            if map_src[j][i]=='.' {
                let mut new_map = map_src.clone();
                new_map[j][i] = '#';
                if calculate_moves(&new_map, &guard_initial) == 0 {
                    loops += 1;
                }
            }
        }
    }
    loops
}

fn parse_guard(map: &Vec<Vec<char>>)->Option<Guard> {
    for y in 0..map.len() {
        for x in 0..map[y].len() {
            if let Some(guard) = match map[y][x] {
                '^' => Some(Guard{pos: Position{x, y}, dir: Direction::Up}),
                'v' => Some(Guard{pos: Position{x, y}, dir: Direction::Down}),
                '>' => Some(Guard{pos: Position{x, y}, dir: Direction::Right}),
                '<' => Some(Guard{pos: Position{x, y}, dir: Direction::Left}),
                _ => None
            } {
                return Some(guard);
            }
        }
    }
    None
}

fn parse_map(source: &str)->Vec<Vec<char>> {
    source.split('\n')
        .collect::<Vec<&str>>()
        .iter()
        .filter(|l| l.len()>0)
        .map(|line|
            line.chars().collect()
        ).collect::<Vec<Vec<char>>>()
}

fn main() {

    let source =
"....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...";
    
    let map = parse_map(&source);
    if let Some(guard) = parse_guard(&map) {
        assert_eq!(41, calculate_moves(&map, &guard));        
        assert_eq!(6, count_loops(&map, &guard));        
    } else {
        println!("Error: cannot find guard in the map.");
    }
    
    let source =
".........#...................................................................................................#.................#..
...........................#.......................................#..............................................................
.............#.................................................................................#............................#.....
...#.....................#.......#....................................#..............#.............................#...........#.#
..........#.....#..#.....#.............#..................#............#.....#........#.#.......#............................#....
...#...................#..........#...................#.........#..#..............##.......................................#......
..................................................................................................#...............................
...............#.........#....#.#..#.........#...........#...#....................#.........#.......#....#........................
..........................................#......#.#...................................................#.............#............
....................#............................#..........................................#.....................#.........#.....
..............#..................................#................#..#...........................................#................
.........#....###.......#........................................................................................#.#.....#...#..#.
.#....................................#.....................................#.................................#..................#
........................#...................................#.#....................#......##.#.........#..........................
............#.......#..................#..........................................................................................
....#.............#.#.....#...#.....#......................#...............#............##...#....................................
...#....#.....................................##........#........#....##.....................................#....................
...........................................................................#........#..........##................................#
..............................#.#......................#..........................#..#........#...............................#...
..............#.........###.......................................#...........#...............#......#.........#........#.....#...
............#............................#....................#........................#............#.............................
.........................................#.....................................................#.....#...............#............
.#...##.......................#.......#..........................................................................#...#...........#
....#..............#............#......#........................#.......................#...#.......................#.............
.......#...............#......#......#..........................................#..................#....................#...#.....
.......................................................................#.........#................................................
.#.......#........................................................##..............................................................
.........................#...................#..#......##..................................#......#......#........................
......................................#..............................................#......#..........#.#.........#..............
.....#..............#..#........#..............................#...##.............................................................
..##............................#.......................................................#..........#..............................
...........................................................##................................................#....................
#...............#.........#.....................................................#......................###........................
#.#.......................#........................#..#.....................#....#........#........................#...#.........#
............#.............#.#............#........................#..........#....................................................
............#...................#.....................................................................................#.......#...
.............................#...#..#...........................#...#.........................................................#...
........#.......................##..........................................................#.........#.....................#.....
............##............#..........................................................#.#.....#......#.#.......#...................
...........#.....#......#.................#.............#......................................#.....#...#........................
#............#.........#.......##.....#......#...........#...........#.......#................#...................................
......#..#...#.....#................................................#............#...#..........^.................................
............................................................................................................#....#................
......................................#.............................#........................#...............#.....#...#..........
...#.........................................................................#....................................................
.....................................#.........................................................#.............#.........#..........
#..............................#...#.................................#............................................................
..........#..................#............#.......#...........................#...................#.....#.........................
............................#...##.............................................................#............#.....................
.................#..................................................................#..#..............#...........................
..................#...............................#................#............#...........#......#............#.................
.....#......................#..............#.......................#......................#.......................................
...............................#.....#.......................#.......#......................#......#............#...........#.....
......#.............##....#.....#...............#.....#............................#....................................#.........
...#.#.......#..#...##.............................................................#.#.#...........#.....#................#.......
...........................................#...#......#...........................................................................
.........#.................................#........................................................................#........#.#..
........................#..........................................#.......#..............#.......................................
....................................................#...............#..........................#..................................
............................#................#......#...............#.....................#.......................................
#.#............#......................................................................................#.....#.....................
................................................................#....#..........................................#........#......#.
.......#........#......................................................................#.................#..................#.#...
...............................#...#......................................................................#.........#.........#...
...........#..#..................##..#.........................................#..............##............................#.....
#........#...............#.....#.....#.................#............#....#.............................#.......#.................#
...............#...................................................#.......#.......................#......#.............#.........
...#............................................................................................................................#.
#.....................#......................................................#...........................................#........
...........#..........................................#.......................................#.....................#.............
....#.##.......#..............#.....#..............................#....................................#.....................#...
...............................................................................................................#...............#..
.#...........................#...#.....#...#...................#....#........#.........#................................#.........
.................#............................................................................#........................#..#.......
.............#....#.....................................................#............#.........................#.......#..........
#....#........................#....................................................................##.............................
...#.#.....................................#...............................................#.....................#....#.........#.
.........#..............................#....................................#.................#............#.....................
................................................................#.................................................................
#.......#..............................................#.............................#...........#................................
.#......#.........#.............................#...............................................................#.................
.........#.....#......#.......................................................................................................#...
#..............................#........#............................#.................................#.....#.....#..............
......#.....................................#.......#........#....................................................................
#.......#.....................................#......................................................................#............
.....................................#......................................#......#.##..................#.....#.#................
.......................#.........#......#...........................................................................##............
.....#......#.#.................................................#.............................#............#.#.......#............
..................#.......................................#.#.............................#..................................#....
......................#.......#.....................#...................#......#.........................................#........
.........#...................................................................................................#....#...............
.........................#...........#..........#...............#.....#...................................................##......
#...#......#.#.....................#..................#.................#..................#......................................
..............................#.....#................#.....................#............#...#....#............#...#...............
.........................#..................#.............................................................................#.......
.......#....................#.......................#.....................#..........#...........#..........#...................#.
....#..........#..#................#.....#..........#........#..................#.....................##...............#.........#
.....................................................................................#......................................#.....
.......................................#...................................#.......................#..........................#...
.......#...............................#............#.....#..............................................#.................#......
.#..........................#..................................................................#...#.#.......#.#..........#.......
#...............................................................#.#............................#...............#......#...........
...#..........................#.#..#.#.............................................................#......#.......................
..................#........#.....................................................#...............................................#
....................#.............#.........#........##................#.............#............#..#............................
.........................#.................................#...........................................#.....#....................
..........................................##..........#................................#........................................#.
.................................................................................#..........#....................##........##.....
.....###......#.....#...................................................................................#..#...................#..
........#.....#.....#.....#..........#.................................................#.#......................#.................
...........................................#....#..............#..#..............#................................................
....#.............#...................................#.....#........................................................#............
.........#........#.............#..................#..........#..........................###.......#....#.#.#.....................
..................#....................#...................#...#..................................................................
.......#...............#................................................................................#................#........
....#..........................#......#....................................#.............#...#......................#...#.........
.#..#....................#.....................#.............#...............................#....................#....##.........
..#..#........#......#.................##..#.......#....................#.............................................#...........
..................#......#.............#.##.................................##.....................................#...#..........
.#...##........#........................................................................................#.....#...#....#..........
............#........................#............................................#.........#.............#.......................
................#......#........#...........................................................#............#........................
..............................#.#......#................................#...........#......................................#......
...................#...................#.............#............#.............#.................................................
.........#.......#....#........#.........#.....................#..#.......#..#...#.............................#..................
.........#...#.........................................................................#.....#.......#............................
.........................#..........#...............................................#.....................................#....#..
....#..................##..##...........#.........#..................................................#...#...........#...........#
.......#.......#.....#...............#.#.....#.............#........................#..............................#..#.........#.
........................#........................................#.............................##.................................";
    
    let map = parse_map(&source);
    if let Some(guard) = parse_guard(&map) {
        assert_eq!(5067, calculate_moves(&map, &guard));        
        assert_eq!(1793, count_loops(&map, &guard));        
    } else {
        println!("Error: cannot find guard in the map.");
    } 
}
